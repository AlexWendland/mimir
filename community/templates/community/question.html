{% extends "base.html" %}

{% load user_inclusions %}

{% block head %}
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.3.1/jquery.cookie.min.js"></script> {# TODO look into other CDNs #}
<script type="text/javascript" charset="utf-8">
var rating = null;
var type = null;
var id = null;
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$(function() {
    var csrftoken = $.cookie('csrftoken');
    $.ajaxSetup({
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
    
    $('.upvote').click(function() {
        if (rating != null)
        {
            $.ajax({
                type: "POST",
                url: "{% url 'community:rate_user_item' %}",
                data: ({rating: true, type: type, id: id}),
            });
            $('.rate').prop('value', 'Thanks!');
        }
    });
    
    $('.downvote').click(function() {
        if (rating != null)
        {
            $.ajax({
                type: "POST",
                url: "{% url 'community:rate_user_item' %}",
                data: ({rating: false, type: type, id: id}),
            });
            $('.rate').prop('value', 'Thanks!');
        }
    });
})
</script>
{% endblock %}

{% comment %}
{% block head %}
{# JS file not used anymore but commented out to see functionality in case of reuse #}

{% load staticfiles %}
<script type="text/javascript" src="{% static "community/javascript/forum.js" %}"></script>
<script type="text/javascript">

$(function() 
{
	var question = {{ question|safe }};
	var answers = {{ answers|safe }};
	var question_comments = {{ q_comments|safe }};
    var answer_comments = {{ a_comments|safe }};
	
	initQuestionPage(question, answers, question_comments, answer_comments) //In forum.js
    
});

</script>

{% endblock %}
{% endcomment %}


{% block content %}

<h2>Community</h2>

<div id="user_question">
<div id="inner_question">
<h2>{{ question.title }}</h2>

{% if question.lesson %}
    <h4>Lesson: <a href={% url 'lessons:read' lesson_name=question.lesson.name.split|join:'_' %}>{{ question.lesson.name }}</a></h4>
{% endif %}

{% if question.question %}
    <h4>Question: {{ displayQuestion.0 }}</h4>
    <h4>Answer: {{ displayQuestion.1 }}</h4>
{% endif %}

<p>{{ question.user_question|linebreaks }}</p>
<p>Created: {{ question.created|date:"H:i D d M Y" }}</p>
<p>Last Modified: {{ question.modified|date:"H:i D d M Y" }}</p>
{% usertag question.user %}
</div>

{% for comment in q_comments %}
    <div id="question_comment{{ forloop.counter }}" class="user_comment">
    <p>{{ comment.user_comment|linebreaks }}</p>
    <p>Created: {{ comment.created|date:"H:i D d M Y" }}</p>
    <p>Last Modified: {{ comment.modified|date:"H:i D d M Y" }}</p>
    {% usertag comment.user %}
    </div>
{% endfor %}
</div>

<div id="user_answers">
{% for answer in answers %}
    <div id="answer{{ forloop.counter }}" class="user_answer">
    <div id="inner_answer">
    <p>{{ answer.user_answer|linebreaks }}</p>
    <p>Created: {{ answer.created|date:"H:i D d M Y" }}</p>
    <p>Last Modified: {{ answer.modified|date:"H:i D d M Y" }}</p>
    {% usertag answer.user %}
    </div>
    
    {# Need to find a better way to get data from 2D array or dict or whatever #}
    {% for c_list in a_comments %}
        {% if forloop.counter == forloop.parentloop.counter %}
            {% for comment in c_list %}
                <div id="answer_comment{{ forloop.counter }}" class="user_comment">
                <p>{{ comment.user_comment|linebreaks }}</p>
                <p>Created: {{ comment.created|date:"H:i D d M Y" }}</p>
                <p>Last Modified: {{ comment.modified|date:"H:i D d M Y" }}</p>
                {% usertag comment.user %}
                </div>
            {% endfor %}
        {% endif %}
    {% endfor %}
    
    </div>
{% endfor %}
</div>

{% endblock %}